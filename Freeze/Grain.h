#ifndef __Grain_h__
#define __Grain_h__

#define WINDOW_SIZE 1024
/** WINDOW LOOKUP TABLE **/
static float WINDOW[WINDOW_SIZE] = { 0.0, 0.0019569471624266144, 0.003913894324853229, 0.005870841487279843, 0.007827788649706457, 0.009784735812133072, 0.011741682974559686, 0.0136986301369863, 0.015655577299412915, 0.01761252446183953, 0.019569471624266144, 0.021526418786692758, 0.023483365949119372, 0.025440313111545987, 0.0273972602739726, 0.029354207436399216, 0.03131115459882583, 0.033268101761252444, 0.03522504892367906, 0.03718199608610567, 0.03913894324853229, 0.0410958904109589, 0.043052837573385516, 0.04500978473581213, 0.046966731898238745, 0.04892367906066536, 0.050880626223091974, 0.05283757338551859, 0.0547945205479452, 0.05675146771037182, 0.05870841487279843, 0.060665362035225046, 0.06262230919765166, 0.06457925636007827, 0.06653620352250489, 0.0684931506849315, 0.07045009784735812, 0.07240704500978473, 0.07436399217221135, 0.07632093933463796, 0.07827788649706457, 0.08023483365949119, 0.0821917808219178, 0.08414872798434442, 0.08610567514677103, 0.08806262230919765, 0.09001956947162426, 0.09197651663405088, 0.09393346379647749, 0.0958904109589041, 0.09784735812133072, 0.09980430528375733, 0.10176125244618395, 0.10371819960861056, 0.10567514677103718, 0.10763209393346379, 0.1095890410958904, 0.11154598825831702, 0.11350293542074363, 0.11545988258317025, 0.11741682974559686, 0.11937377690802348, 0.12133072407045009, 0.1232876712328767, 0.12524461839530332, 0.12720156555772993, 0.12915851272015655, 0.13111545988258316, 0.13307240704500978, 0.1350293542074364, 0.136986301369863, 0.13894324853228962, 0.14090019569471623, 0.14285714285714285, 0.14481409001956946, 0.14677103718199608, 0.1487279843444227, 0.1506849315068493, 0.15264187866927592, 0.15459882583170254, 0.15655577299412915, 0.15851272015655576, 0.16046966731898238, 0.162426614481409, 0.1643835616438356, 0.16634050880626222, 0.16829745596868884, 0.17025440313111545, 0.17221135029354206, 0.17416829745596868, 0.1761252446183953, 0.1780821917808219, 0.18003913894324852, 0.18199608610567514, 0.18395303326810175, 0.18590998043052837, 0.18786692759295498, 0.1898238747553816, 0.1917808219178082, 0.19373776908023482, 0.19569471624266144, 0.19765166340508805, 0.19960861056751467, 0.20156555772994128, 0.2035225048923679, 0.2054794520547945, 0.20743639921722112, 0.20939334637964774, 0.21135029354207435, 0.21330724070450097, 0.21526418786692758, 0.2172211350293542, 0.2191780821917808, 0.22113502935420742, 0.22309197651663404, 0.22504892367906065, 0.22700587084148727, 0.22896281800391388, 0.2309197651663405, 0.2328767123287671, 0.23483365949119372, 0.23679060665362034, 0.23874755381604695, 0.24070450097847357, 0.24266144814090018, 0.2446183953033268, 0.2465753424657534, 0.24853228962818003, 0.25048923679060664, 0.25244618395303325, 0.25440313111545987, 0.2563600782778865, 0.2583170254403131, 0.2602739726027397, 0.2622309197651663, 0.26418786692759294, 0.26614481409001955, 0.26810176125244617, 0.2700587084148728, 0.2720156555772994, 0.273972602739726, 0.2759295499021526, 0.27788649706457924, 0.27984344422700586, 0.28180039138943247, 0.2837573385518591, 0.2857142857142857, 0.2876712328767123, 0.2896281800391389, 0.29158512720156554, 0.29354207436399216, 0.29549902152641877, 0.2974559686888454, 0.299412915851272, 0.3013698630136986, 0.30332681017612523, 0.30528375733855184, 0.30724070450097846, 0.30919765166340507, 0.3111545988258317, 0.3131115459882583, 0.3150684931506849, 0.31702544031311153, 0.31898238747553814, 0.32093933463796476, 0.32289628180039137, 0.324853228962818, 0.3268101761252446, 0.3287671232876712, 0.33072407045009783, 0.33268101761252444, 0.33463796477495106, 0.33659491193737767, 0.3385518590998043, 0.3405088062622309, 0.3424657534246575, 0.34442270058708413, 0.34637964774951074, 0.34833659491193736, 0.350293542074364, 0.3522504892367906, 0.3542074363992172, 0.3561643835616438, 0.35812133072407043, 0.36007827788649704, 0.36203522504892366, 0.3639921722113503, 0.3659491193737769, 0.3679060665362035, 0.3698630136986301, 0.37181996086105673, 0.37377690802348335, 0.37573385518590996, 0.3776908023483366, 0.3796477495107632, 0.3816046966731898, 0.3835616438356164, 0.38551859099804303, 0.38747553816046965, 0.38943248532289626, 0.3913894324853229, 0.3933463796477495, 0.3953033268101761, 0.3972602739726027, 0.39921722113502933, 0.40117416829745595, 0.40313111545988256, 0.4050880626223092, 0.4070450097847358, 0.4090019569471624, 0.410958904109589, 0.41291585127201563, 0.41487279843444225, 0.41682974559686886, 0.4187866927592955, 0.4207436399217221, 0.4227005870841487, 0.4246575342465753, 0.42661448140900193, 0.42857142857142855, 0.43052837573385516, 0.4324853228962818, 0.4344422700587084, 0.436399217221135, 0.4383561643835616, 0.44031311154598823, 0.44227005870841485, 0.44422700587084146, 0.4461839530332681, 0.4481409001956947, 0.4500978473581213, 0.4520547945205479, 0.45401174168297453, 0.45596868884540115, 0.45792563600782776, 0.4598825831702544, 0.461839530332681, 0.4637964774951076, 0.4657534246575342, 0.46771037181996084, 0.46966731898238745, 0.47162426614481406, 0.4735812133072407, 0.4755381604696673, 0.4774951076320939, 0.4794520547945205, 0.48140900195694714, 0.48336594911937375, 0.48532289628180036, 0.487279843444227, 0.4892367906066536, 0.4911937377690802, 0.4931506849315068, 0.49510763209393344, 0.49706457925636005, 0.49902152641878667, 0.5009784735812133, 0.50293542074364, 0.5048923679060665, 0.5068493150684932, 0.5088062622309197, 0.5107632093933464, 0.512720156555773, 0.5146771037181996, 0.5166340508806262, 0.5185909980430529, 0.5205479452054794, 0.5225048923679061, 0.5244618395303327, 0.5264187866927593, 0.5283757338551859, 0.5303326810176126, 0.5322896281800391, 0.5342465753424658, 0.5362035225048923, 0.538160469667319, 0.5401174168297456, 0.5420743639921722, 0.5440313111545988, 0.5459882583170255, 0.547945205479452, 0.5499021526418787, 0.5518590998043053, 0.5538160469667319, 0.5557729941291585, 0.5577299412915852, 0.5596868884540117, 0.5616438356164384, 0.5636007827788649, 0.5655577299412916, 0.5675146771037182, 0.5694716242661448, 0.5714285714285714, 0.5733855185909981, 0.5753424657534246, 0.5772994129158513, 0.5792563600782779, 0.5812133072407045, 0.5831702544031311, 0.5851272015655578, 0.5870841487279843, 0.589041095890411, 0.5909980430528375, 0.5929549902152642, 0.5949119373776908, 0.5968688845401174, 0.598825831702544, 0.6007827788649707, 0.6027397260273972, 0.6046966731898239, 0.6066536203522505, 0.6086105675146771, 0.6105675146771037, 0.6125244618395304, 0.6144814090019569, 0.6164383561643836, 0.6183953033268101, 0.6203522504892368, 0.6223091976516634, 0.62426614481409, 0.6262230919765166, 0.6281800391389433, 0.6301369863013698, 0.6320939334637965, 0.6340508806262231, 0.6360078277886497, 0.6379647749510763, 0.639921722113503, 0.6418786692759295, 0.6438356164383562, 0.6457925636007827, 0.6477495107632094, 0.649706457925636, 0.6516634050880626, 0.6536203522504892, 0.6555772994129159, 0.6575342465753424, 0.6594911937377691, 0.6614481409001957, 0.6634050880626223, 0.6653620352250489, 0.6673189823874756, 0.6692759295499021, 0.6712328767123288, 0.6731898238747553, 0.675146771037182, 0.6771037181996086, 0.6790606653620352, 0.6810176125244618, 0.6829745596868885, 0.684931506849315, 0.6868884540117417, 0.6888454011741683, 0.6908023483365949, 0.6927592954990215, 0.6947162426614482, 0.6966731898238747, 0.6986301369863014, 0.700587084148728, 0.7025440313111546, 0.7045009784735812, 0.7064579256360078, 0.7084148727984344, 0.7103718199608611, 0.7123287671232876, 0.7142857142857143, 0.7162426614481409, 0.7181996086105675, 0.7201565557729941, 0.7221135029354208, 0.7240704500978473, 0.726027397260274, 0.7279843444227005, 0.7299412915851272, 0.7318982387475538, 0.7338551859099804, 0.735812133072407, 0.7377690802348337, 0.7397260273972602, 0.7416829745596869, 0.7436399217221135, 0.7455968688845401, 0.7475538160469667, 0.7495107632093934, 0.7514677103718199, 0.7534246575342466, 0.7553816046966731, 0.7573385518590998, 0.7592954990215264, 0.761252446183953, 0.7632093933463796, 0.7651663405088063, 0.7671232876712328, 0.7690802348336595, 0.7710371819960861, 0.7729941291585127, 0.7749510763209393, 0.776908023483366, 0.7788649706457925, 0.7808219178082192, 0.7827788649706457, 0.7847358121330724, 0.786692759295499, 0.7886497064579256, 0.7906066536203522, 0.7925636007827789, 0.7945205479452054, 0.7964774951076321, 0.7984344422700587, 0.8003913894324853, 0.8023483365949119, 0.8043052837573386, 0.8062622309197651, 0.8082191780821918, 0.8101761252446184, 0.812133072407045, 0.8140900195694716, 0.8160469667318982, 0.8180039138943248, 0.8199608610567515, 0.821917808219178, 0.8238747553816047, 0.8258317025440313, 0.8277886497064579, 0.8297455968688845, 0.8317025440313112, 0.8336594911937377, 0.8356164383561644, 0.837573385518591, 0.8395303326810176, 0.8414872798434442, 0.8434442270058709, 0.8454011741682974, 0.8473581213307241, 0.8493150684931506, 0.8512720156555773, 0.8532289628180039, 0.8551859099804305, 0.8571428571428571, 0.8590998043052838, 0.8610567514677103, 0.863013698630137, 0.8649706457925636, 0.8669275929549902, 0.8688845401174168, 0.8708414872798435, 0.87279843444227, 0.8747553816046967, 0.8767123287671232, 0.8786692759295499, 0.8806262230919765, 0.8825831702544031, 0.8845401174168297, 0.8864970645792564, 0.8884540117416829, 0.8904109589041096, 0.8923679060665362, 0.8943248532289628, 0.8962818003913894, 0.898238747553816, 0.9001956947162426, 0.9021526418786693, 0.9041095890410958, 0.9060665362035225, 0.9080234833659491, 0.9099804305283757, 0.9119373776908023, 0.913894324853229, 0.9158512720156555, 0.9178082191780822, 0.9197651663405088, 0.9217221135029354, 0.923679060665362, 0.9256360078277887, 0.9275929549902152, 0.9295499021526419, 0.9315068493150684, 0.9334637964774951, 0.9354207436399217, 0.9373776908023483, 0.9393346379647749, 0.9412915851272016, 0.9432485322896281, 0.9452054794520548, 0.9471624266144814, 0.949119373776908, 0.9510763209393346, 0.9530332681017613, 0.9549902152641878, 0.9569471624266145, 0.958904109589041, 0.9608610567514677, 0.9628180039138943, 0.9647749510763209, 0.9667318982387475, 0.9686888454011742, 0.9706457925636007, 0.9726027397260274, 0.974559686888454, 0.9765166340508806, 0.9784735812133072, 0.9804305283757339, 0.9823874755381604, 0.9843444227005871, 0.9863013698630136, 0.9882583170254403, 0.9902152641878669, 0.9921722113502935, 0.9941291585127201, 0.9960861056751468, 0.9980430528375733, 1.0, 1.0, 0.9980430528375733, 0.9960861056751468, 0.9941291585127201, 0.9921722113502935, 0.9902152641878669, 0.9882583170254403, 0.9863013698630136, 0.9843444227005871, 0.9823874755381604, 0.9804305283757339, 0.9784735812133072, 0.9765166340508806, 0.974559686888454, 0.9726027397260274, 0.9706457925636007, 0.9686888454011742, 0.9667318982387475, 0.9647749510763209, 0.9628180039138943, 0.9608610567514677, 0.958904109589041, 0.9569471624266145, 0.9549902152641878, 0.9530332681017613, 0.9510763209393346, 0.949119373776908, 0.9471624266144814, 0.9452054794520548, 0.9432485322896281, 0.9412915851272016, 0.9393346379647749, 0.9373776908023483, 0.9354207436399217, 0.9334637964774951, 0.9315068493150684, 0.9295499021526419, 0.9275929549902152, 0.9256360078277887, 0.923679060665362, 0.9217221135029354, 0.9197651663405088, 0.9178082191780822, 0.9158512720156555, 0.913894324853229, 0.9119373776908023, 0.9099804305283757, 0.9080234833659491, 0.9060665362035225, 0.9041095890410958, 0.9021526418786693, 0.9001956947162426, 0.898238747553816, 0.8962818003913894, 0.8943248532289628, 0.8923679060665362, 0.8904109589041096, 0.8884540117416829, 0.8864970645792564, 0.8845401174168297, 0.8825831702544031, 0.8806262230919765, 0.8786692759295499, 0.8767123287671232, 0.8747553816046967, 0.87279843444227, 0.8708414872798435, 0.8688845401174168, 0.8669275929549902, 0.8649706457925636, 0.863013698630137, 0.8610567514677103, 0.8590998043052838, 0.8571428571428571, 0.8551859099804305, 0.8532289628180039, 0.8512720156555773, 0.8493150684931506, 0.8473581213307241, 0.8454011741682974, 0.8434442270058709, 0.8414872798434442, 0.8395303326810176, 0.837573385518591, 0.8356164383561644, 0.8336594911937377, 0.8317025440313112, 0.8297455968688845, 0.8277886497064579, 0.8258317025440313, 0.8238747553816047, 0.821917808219178, 0.8199608610567515, 0.8180039138943248, 0.8160469667318982, 0.8140900195694716, 0.812133072407045, 0.8101761252446184, 0.8082191780821918, 0.8062622309197651, 0.8043052837573386, 0.8023483365949119, 0.8003913894324853, 0.7984344422700587, 0.7964774951076321, 0.7945205479452054, 0.7925636007827789, 0.7906066536203522, 0.7886497064579256, 0.786692759295499, 0.7847358121330724, 0.7827788649706457, 0.7808219178082192, 0.7788649706457925, 0.776908023483366, 0.7749510763209393, 0.7729941291585127, 0.7710371819960861, 0.7690802348336595, 0.7671232876712328, 0.7651663405088063, 0.7632093933463796, 0.761252446183953, 0.7592954990215264, 0.7573385518590998, 0.7553816046966731, 0.7534246575342466, 0.7514677103718199, 0.7495107632093934, 0.7475538160469667, 0.7455968688845401, 0.7436399217221135, 0.7416829745596869, 0.7397260273972602, 0.7377690802348337, 0.735812133072407, 0.7338551859099804, 0.7318982387475538, 0.7299412915851272, 0.7279843444227005, 0.726027397260274, 0.7240704500978473, 0.7221135029354208, 0.7201565557729941, 0.7181996086105675, 0.7162426614481409, 0.7142857142857143, 0.7123287671232876, 0.7103718199608611, 0.7084148727984344, 0.7064579256360078, 0.7045009784735812, 0.7025440313111546, 0.700587084148728, 0.6986301369863014, 0.6966731898238747, 0.6947162426614482, 0.6927592954990215, 0.6908023483365949, 0.6888454011741683, 0.6868884540117417, 0.684931506849315, 0.6829745596868885, 0.6810176125244618, 0.6790606653620352, 0.6771037181996086, 0.675146771037182, 0.6731898238747553, 0.6712328767123288, 0.6692759295499021, 0.6673189823874756, 0.6653620352250489, 0.6634050880626223, 0.6614481409001957, 0.6594911937377691, 0.6575342465753424, 0.6555772994129159, 0.6536203522504892, 0.6516634050880626, 0.649706457925636, 0.6477495107632094, 0.6457925636007827, 0.6438356164383562, 0.6418786692759295, 0.639921722113503, 0.6379647749510763, 0.6360078277886497, 0.6340508806262231, 0.6320939334637965, 0.6301369863013698, 0.6281800391389433, 0.6262230919765166, 0.62426614481409, 0.6223091976516634, 0.6203522504892368, 0.6183953033268101, 0.6164383561643836, 0.6144814090019569, 0.6125244618395304, 0.6105675146771037, 0.6086105675146771, 0.6066536203522505, 0.6046966731898239, 0.6027397260273972, 0.6007827788649707, 0.598825831702544, 0.5968688845401174, 0.5949119373776908, 0.5929549902152642, 0.5909980430528375, 0.589041095890411, 0.5870841487279843, 0.5851272015655578, 0.5831702544031311, 0.5812133072407045, 0.5792563600782779, 0.5772994129158513, 0.5753424657534246, 0.5733855185909981, 0.5714285714285714, 0.5694716242661448, 0.5675146771037182, 0.5655577299412916, 0.5636007827788649, 0.5616438356164384, 0.5596868884540117, 0.5577299412915852, 0.5557729941291585, 0.5538160469667319, 0.5518590998043053, 0.5499021526418787, 0.547945205479452, 0.5459882583170255, 0.5440313111545988, 0.5420743639921722, 0.5401174168297456, 0.538160469667319, 0.5362035225048923, 0.5342465753424658, 0.5322896281800391, 0.5303326810176126, 0.5283757338551859, 0.5264187866927593, 0.5244618395303327, 0.5225048923679061, 0.5205479452054794, 0.5185909980430529, 0.5166340508806262, 0.5146771037181996, 0.512720156555773, 0.5107632093933464, 0.5088062622309197, 0.5068493150684932, 0.5048923679060665, 0.50293542074364, 0.5009784735812133, 0.49902152641878667, 0.49706457925636005, 0.49510763209393344, 0.4931506849315068, 0.4911937377690802, 0.4892367906066536, 0.487279843444227, 0.48532289628180036, 0.48336594911937375, 0.48140900195694714, 0.4794520547945205, 0.4774951076320939, 0.4755381604696673, 0.4735812133072407, 0.47162426614481406, 0.46966731898238745, 0.46771037181996084, 0.4657534246575342, 0.4637964774951076, 0.461839530332681, 0.4598825831702544, 0.45792563600782776, 0.45596868884540115, 0.45401174168297453, 0.4520547945205479, 0.4500978473581213, 0.4481409001956947, 0.4461839530332681, 0.44422700587084146, 0.44227005870841485, 0.44031311154598823, 0.4383561643835616, 0.436399217221135, 0.4344422700587084, 0.4324853228962818, 0.43052837573385516, 0.42857142857142855, 0.42661448140900193, 0.4246575342465753, 0.4227005870841487, 0.4207436399217221, 0.4187866927592955, 0.41682974559686886, 0.41487279843444225, 0.41291585127201563, 0.410958904109589, 0.4090019569471624, 0.4070450097847358, 0.4050880626223092, 0.40313111545988256, 0.40117416829745595, 0.39921722113502933, 0.3972602739726027, 0.3953033268101761, 0.3933463796477495, 0.3913894324853229, 0.38943248532289626, 0.38747553816046965, 0.38551859099804303, 0.3835616438356164, 0.3816046966731898, 0.3796477495107632, 0.3776908023483366, 0.37573385518590996, 0.37377690802348335, 0.37181996086105673, 0.3698630136986301, 0.3679060665362035, 0.3659491193737769, 0.3639921722113503, 0.36203522504892366, 0.36007827788649704, 0.35812133072407043, 0.3561643835616438, 0.3542074363992172, 0.3522504892367906, 0.350293542074364, 0.34833659491193736, 0.34637964774951074, 0.34442270058708413, 0.3424657534246575, 0.3405088062622309, 0.3385518590998043, 0.33659491193737767, 0.33463796477495106, 0.33268101761252444, 0.33072407045009783, 0.3287671232876712, 0.3268101761252446, 0.324853228962818, 0.32289628180039137, 0.32093933463796476, 0.31898238747553814, 0.31702544031311153, 0.3150684931506849, 0.3131115459882583, 0.3111545988258317, 0.30919765166340507, 0.30724070450097846, 0.30528375733855184, 0.30332681017612523, 0.3013698630136986, 0.299412915851272, 0.2974559686888454, 0.29549902152641877, 0.29354207436399216, 0.29158512720156554, 0.2896281800391389, 0.2876712328767123, 0.2857142857142857, 0.2837573385518591, 0.28180039138943247, 0.27984344422700586, 0.27788649706457924, 0.2759295499021526, 0.273972602739726, 0.2720156555772994, 0.2700587084148728, 0.26810176125244617, 0.26614481409001955, 0.26418786692759294, 0.2622309197651663, 0.2602739726027397, 0.2583170254403131, 0.2563600782778865, 0.25440313111545987, 0.25244618395303325, 0.25048923679060664, 0.24853228962818003, 0.2465753424657534, 0.2446183953033268, 0.24266144814090018, 0.24070450097847357, 0.23874755381604695, 0.23679060665362034, 0.23483365949119372, 0.2328767123287671, 0.2309197651663405, 0.22896281800391388, 0.22700587084148727, 0.22504892367906065, 0.22309197651663404, 0.22113502935420742, 0.2191780821917808, 0.2172211350293542, 0.21526418786692758, 0.21330724070450097, 0.21135029354207435, 0.20939334637964774, 0.20743639921722112, 0.2054794520547945, 0.2035225048923679, 0.20156555772994128, 0.19960861056751467, 0.19765166340508805, 0.19569471624266144, 0.19373776908023482, 0.1917808219178082, 0.1898238747553816, 0.18786692759295498, 0.18590998043052837, 0.18395303326810175, 0.18199608610567514, 0.18003913894324852, 0.1780821917808219, 0.1761252446183953, 0.17416829745596868, 0.17221135029354206, 0.17025440313111545, 0.16829745596868884, 0.16634050880626222, 0.1643835616438356, 0.162426614481409, 0.16046966731898238, 0.15851272015655576, 0.15655577299412915, 0.15459882583170254, 0.15264187866927592, 0.1506849315068493, 0.1487279843444227, 0.14677103718199608, 0.14481409001956946, 0.14285714285714285, 0.14090019569471623, 0.13894324853228962, 0.136986301369863, 0.1350293542074364, 0.13307240704500978, 0.13111545988258316, 0.12915851272015655, 0.12720156555772993, 0.12524461839530332, 0.1232876712328767, 0.12133072407045009, 0.11937377690802348, 0.11741682974559686, 0.11545988258317025, 0.11350293542074363, 0.11154598825831702, 0.1095890410958904, 0.10763209393346379, 0.10567514677103718, 0.10371819960861056, 0.10176125244618395, 0.09980430528375733, 0.09784735812133072, 0.0958904109589041, 0.09393346379647749, 0.09197651663405088, 0.09001956947162426, 0.08806262230919765, 0.08610567514677103, 0.08414872798434442, 0.0821917808219178, 0.08023483365949119, 0.07827788649706457, 0.07632093933463796, 0.07436399217221135, 0.07240704500978473, 0.07045009784735812, 0.0684931506849315, 0.06653620352250489, 0.06457925636007827, 0.06262230919765166, 0.060665362035225046, 0.05870841487279843, 0.05675146771037182, 0.0547945205479452, 0.05283757338551859, 0.050880626223091974, 0.04892367906066536, 0.046966731898238745, 0.04500978473581213, 0.043052837573385516, 0.0410958904109589, 0.03913894324853229, 0.03718199608610567, 0.03522504892367906, 0.033268101761252444, 0.03131115459882583, 0.029354207436399216, 0.0273972602739726, 0.025440313111545987, 0.023483365949119372, 0.021526418786692758, 0.019569471624266144, 0.01761252446183953, 0.015655577299412915, 0.0136986301369863, 0.011741682974559686, 0.009784735812133072, 0.007827788649706457, 0.005870841487279843, 0.003913894324853229, 0.0019569471624266144, 0.0 };

/**
 * Clase que representa un grano en un sintetizador granular
 * @author jose
 */
class Grain {
private:
	FloatArray	buffer;
	FloatArray	window;

	float	playIndex;
	int	recordIndex;
	float	grainSize;
	float	speed;
	bool	eraseHead;

	Grain*	_next;

	float	nextGrainIndex;


	void generateWindow( float* win ) {
		for ( int i = 0; i < WINDOW_SIZE; i++ )
			win[i] = WINDOW[i];
	}

public:
	/**
	 * Constructor con asignación de buffer. El delay puede crear
	 * su propio buffer pero es posible necesitar utilizar un buffer
	 * ya creado por otra instancia del delay.
	 */
	Grain( float* buf, int size, float nGrainIndex ) :
			buffer( buf, size ){
		playIndex = 0;
		recordIndex = 0;
		grainSize = size;
		speed = 1;
		eraseHead = false;

		window = FloatArray::create( WINDOW_SIZE );

		// Window generation
		float* win = Grain::window.getData( );
		generateWindow( win );

		nextGrainIndex = nGrainIndex;
	}

	/**
	 * Constructor con creación de buffer.
	 */
	Grain( int size, float nGrainIndex ) {
		playIndex = 0;
		recordIndex = 0;
		grainSize = size;
		speed = 1;
		eraseHead = false;

		nextGrainIndex = nGrainIndex;

		window = FloatArray::create( WINDOW_SIZE );
		buffer = FloatArray::create( size );

		// Window generation
		float* win = Grain::window.getData( );
		generateWindow( win );
	}

	~Grain( ) {
		if( Grain::window.getData( ) != NULL )
			FloatArray::destroy( Grain::window );
	}

	/**
	 * Asigna valores al buffer a partir de 'index'
	 * @param buff		Buffer con los valores de entrada.
	 * @return Verdadero si todavía no se llenó el buffer.
	 */
	inline bool push( float* buff, int size, float overWrite ) {
		float* b = buffer.getData( );
		int initial = recordIndex;
		int last = recordIndex + size;
		for ( int i = initial; i < last; i++ ) {
			if ( recordIndex >= buffer.getSize( ) ) {
				recordIndex = 0;
				return false;
			}
			b[recordIndex] = overWrite * buff[i - initial] + ( 1 - overWrite ) * b[recordIndex];
			recordIndex++;
			// Se borra la muestra dos posiciones delante de la recogida
			/*if ( eraseHead )
				b[( recordIndex + 1 ) % buffer.getSize( )] = 0;*/
		}
		return true;
	}

	inline bool erase( int size ) {
		float* b = buffer.getData( );
		int initial = recordIndex;
		int last = recordIndex + size;
		for ( int i = initial; i < last; i++ ) {
			if ( recordIndex >= buffer.getSize( ) ) {
				recordIndex = 0;
				return false;
			}
			b[recordIndex] = 0;
			recordIndex++;
		}
		return true;
	}


	/**
	 *
	 */
	inline float pull( ) {
		playIndex += speed;
		if ( playIndex >= grainSize ) {
			playIndex = 0;
		} else if ( playIndex < 0 ) {
                    playIndex = grainSize - 1;
                }
		if ( ( int ) playIndex == ( int ) ( grainSize * nextGrainIndex ) )
			_next->play( );
		return interpolate( playIndex );
	}

	/**
	 * Genera un valor interpolado para un indice decimal;
	 */
	inline float interpolate( float index ) {
		int idx = ( int ) index;
		float low = buffer.getData( )[idx];
		float high = buffer.getData( )[idx+1];

		float frac = index - idx;
		float value = low * frac + high * ( 1 - frac );

		int winIndex = ( WINDOW_SIZE - 1 ) * ( float ) playIndex / grainSize;
		return value * window[winIndex];
	}

	void play( ) {
		playIndex = 0;
	}

	/**
	 * Activa o desactiva el cabezal de borrado
	 */
	void erase( bool b ) {
		eraseHead = b;
	}

	void setSize( int size ) {
		grainSize = size;
		if ( grainSize > buffer.getSize( ) )
			grainSize = buffer.getSize( );
		if ( grainSize < 1 )
			grainSize = 1;
	}

	Grain* next( ) {
		return _next;
	}

	void setNext( Grain* next ) {
		_next = next;
	}

	void setSpeed( float s ) {
		speed = s;
	}

	void setIndex( float index ) {
		playIndex = index;
	}
};

#endif // __Grain_h__
